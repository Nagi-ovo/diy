之前我们优化的方法只是简单的降低函数调用的开销，以及消除不必要的内存引用等。想进一步提升程序的性能，我们必须考虑利用处理器的微体系结构来进行优化，也就是弄清楚现代处理器是如何执行指令的。

第四章讲述过处理器的五级流水实现，实际上现代处理器的内部结构要复杂得多，能够同时执行多条指令，我们称这种技术为**指令级并行**。

现代处理器的整体设计主要分为两部分：指令控制单元（ICU）和执行单元（EU）

![](storage%20bag/Screenshot%202024-02-29%20at%2009.58.38.png)

指令控制单元负责从内存中读取指令序列，然后对指令进行[译码](4.3%20Y86-64的实现顺序.md#^e4038a))，从而产生一系列操作。 

现代处理器每个时钟周期可以执行多个操作，而且是乱序执行的，也就是允许指令的执行顺序与原始程序中的顺序不一样。

现代处理器采用分支预测技术来猜测是否选择分支，预测分支的目标地址，甚至在不确定分支预测是否正确之前就开始执行这些指令。如果之后发现分支预测错误，会将状态重新设置到分支点之前的状态。这种技术称为**投机执行**。

这种技术中，执行结果暂时不会存放到寄存器文件或者内存中，直到可以确认应该执行这些指令时，再把结果写回道寄存器或内存。分支操作被指令控制单元送到执行单元，注意这里的分支逻辑单元是用来确定分支预测是否正确，而不是确定分支该往哪里执行。如果预测错误，执行单元会丢弃分支点之后的计算结果，还会发信号告诉分支单元“预测是错误的”，并指出正确的分支，分支逻辑单元开始在新的位置取指。

在指令执行单元中，还有一个退役单元，它包含寄存器文件，同时控制着寄存器的更新。

## 功能单元的性能指标

![](storage%20bag/Screenshot%202024-02-29%20at%2010.52.46.png)

三个名词：
- 延迟（Latency）：完成运算所需要的总时间
- 发射（Issue）：两次运算之间间隔的最小时钟周期数
- 容量（Capacity）：执行该功能的功能单元数量

要注意的是，除法运算的延迟和发射时间不是一个精确的时钟周期，而是一个范围，因为它依赖于被除数和除数。


