## Pipeline Control Logic

为了处理流水线的冒险以及异常情况，我们需要在设计中添加**控制逻辑单元**。

![](storage%20bag/Screenshot%202024-02-27%20at%2022.59.45.png)

1. 二者存在[数据相关](4.7%20数据冒险.md#^ec594c)，此时我们希望指令addq可以阻塞在译码阶段，等待指令mrmovq完成访存操作后，通过数据转发逻辑来解决这个数据冒险。然后继续执行指令addq

流水线的控制逻辑不仅要检测这种冒险的发生，还要使得指令按照期望的方向去执行。具体的解决方法是：保持流水线寄存器F和D的状态不变，同时向寄存器E中插入一个*bubble*，这样二者之间的冒险就解决了。

![](storage%20bag/Screenshot%202024-02-27%20at%2023.00.08.png)

详细解释：
在流水线处理器设计中，当后续指令依赖于前一指令的结果时，就会发生数据冒险。在图一中，`addq` 指令需要使用由 `mrmovq` 指令写入 `%rax` 寄存器的数据，但由于 `mrmovq` 指令的结果尚未写回 `%rax` 寄存器，因此 `addq` 无法在其执行（E）阶段获取必要的数据。

为了解决这个问题，处理器可以采用流水线暂停（stalling）和插入气泡（bubbling）的策略，如图二所示。这两种方法都是为了等待 `mrmovq` 指令完成并将数据写回 `%rax` 寄存器，从而让 `addq` 指令可以正确执行。

1. **Stall（暂停）**：在取指（F）和译码（D）阶段插入 stall 指的是暂停流水线的前进。在这个例子中，处理器检测到 `addq` 指令需要等待 `mrmovq` 指令完成，因此它暂停了取指和译码阶段，等待必要的数据变得可用。这样，`addq` 指令在执行阶段之前不会进入下一个流水线阶段。

2. **Bubble（气泡）**：在执行（E）阶段插入 nop（no operation，无操作）指令被称为插入气泡。气泡是流水线中的一个空周期，相当于让处理器在这个阶段什么都不做。这样做的目的是给 `mrmovq` 指令额外的时间来完成写回操作，而不是让 `addq` 指令用尚未更新的寄存器值进行错误的操作。

指令popq同样可能会产生加载/使用的冒险情况。

2. 分支预测发生错误

下一个时钟周期，需要取消两条已经收到的指令

![](storage%20bag/Screenshot%202024-02-27%20at%2023.07.36.png)

3. 返回指令的处理

![](storage%20bag/Screenshot%202024-02-27%20at%2023.11.47.png)

取指阶段会不断取出错误的指令，但是在译码阶段就被替换成了气泡，气泡会经过剩下的流水阶段，因此插入3个气泡就可以达到期望的效果

![](storage%20bag/Screenshot%202024-02-27%20at%2023.12.03.png)

4. 异常的处理

以上四种特殊情况的处理，可以通过流水线的控制逻辑来实现，控制逻辑的操作就是在出现特殊情况时，通过暂停和插入气泡来保证程序的正确执行。

通俗地说：
- 暂停`stall`=保持流水线寄存器的状态不变
- 插入气泡`bubble`=对寄存器状态做“清零”操作`nop`

目前为止，我们假设任意一个时钟周期内，最多只能出现一个特殊情况，实际会有组合。

## 处理器性能分析

为了定量分析我们设计的处理器性能，我们引入了**CPI**(*Cycles Per Instruction*)的概念，它表示一条指令执行所需要的时钟周期数。

![](storage%20bag/Screenshot%202024-02-27%20at%2023.23.05.png)
> 其中lp表示由于加载/使用冒险暂停时插入气泡的平均数，mp表示由于分支预测错误取消指令时插入的气泡平均数，rp表示返回指令造成暂停时插入的气泡平均数

这里的$C_b/C_i$可以理解为惩罚项，它表示执行一条指令平均要插入多少个气泡。

假设一个程序中，加载指令占所有执行指令的25%，其中20%会导致加载/使用冒险；跳转指令占20%，其中60%执行跳转，40%不执行跳转；返回指令占所有指令的2%。

![](storage%20bag/Screenshot%202024-02-27%20at%2023.27.53.png)

可以计算出三种惩罚的综合是0.27，因此CPI=1+0.27=1.27，也就是平均执行一条指令需要1.27个时钟周期。这与我们期望的每个时钟周期都执行一条指令相比有些差距，如果想要进一步降低CPI，需要提高处理器性能，降低分支预测的错误。


